<!DOCTYPE html>
<meta charset="utf-8">
<style>

.node {
  stroke: #000;
  stroke-width: 0.5px;
}

.link {
  stroke: #999;
  stroke-opacity: .6;
  fill: none;
  stroke-width: 1.5px;
}

text {
  stroke: #000;
  font: 10px sans-serif;
  font-weight: normal;
  font-style: normal;
  pointer-events: none;
}

form {
  position: absolute;
  right: 10px;
  top: 10px;
}

</style>
<body>
<script src="Scripts/d3.v3.js"></script>
<script src="origin.js"></script>
<script>

//  ===================================================
//  =============== CONFIGURABLE PARAMS  ==============
//  ===================================================

var width = 1900,
    height = 800;

var default_link_distance = 10;   

// How far can we change default_link_distance?
// 0   - I don't care
// 0.5 - Change it as you want, but it's preferrable to have default_link_distance 
// 1   - One does not change default_link_distance
var default_link_strength = 0.7;

// Should I comment this?
var deafult_circle_radius = 15;

// you can set it to true, but this will not help to understanf what's going on
var show_texts_near_circles = false;
var default_max_texts_length = 100;

// Should we use regexp-based  grouping or not
var use_regexp_color_grouping_matchers = false;

var charge_multiplier = 100;

// Each item thet matches specified regexps will be placed to correspondent group with unique color
var regexp_color_matchers = [
  "^NI",  // Nimbus
  "^UI",  // UIKit
  "^NS",  // Foundation
  "^CA",  // Core animations
];
</script>
<script src="Scripts/parse.js"></script>
<form>
  <label><input type="range" name="circle_size" min="1" max="50" value="15"> Circle size</label><br>
  <label><input type="range" name="charge_multiplier" min="1" max="500" value="100"> Charge multiplier</label><br>
  <label><input type="range" name="link_strength" min="0.1" max="100" value="7"> Link strength</label><br>
  <label><input type="checkbox" name="show_texts_near_circles" checked="false"> Show names</label><br>
  <div id="myDiv">
        <input type="text" id="txt_1" onkeydown="newTextBox(this)" />
   </div>

</form>
<script type="text/javascript">

function newTextBox(element){
   if(!element.value){
       element.parentNode.removeChild( element.nextElementSibling);
       return;
   }
   else if(element.nextElementSibling)
       return;
    var newTxt = element.cloneNode();
    newTxt.id = 'txt_'+( parseInt( element.id.substring(element.id.indexOf('_')+1)) + 1);
    newTxt.value='';
    element.parentNode.appendChild(newTxt);
}  

</script>
<script>

var dependecy_graph = objcdv.parse_dependencies_graph(dependencies);

//  ===================================================
//  =============== http://d3js.org/ Magic ===========
//  ===================================================

// https://github.com/mbostock/d3/wiki/Ordinal-Scales#categorical-colors
var color = d3.scale.category10();

var w = window,
    d = document,
    e = d.documentElement,
    g = d.getElementsByTagName('body')[0],
    x = w.innerWidth || e.clientWidth || g.clientWidth,
    y = w.innerHeight|| e.clientHeight|| g.clientHeight;

var force = d3.layout.force()
    .charge(function(d) { return -d.weight * charge_multiplier;})
    .linkDistance(function(l) { return radius(l.source) + radius(l.target) + default_link_distance;})
    .size([x, y]);


var svg = d3.select("body").append("svg")
    .attr("width", x)
    .attr("height", y);

  force
      .nodes(d3.values(dependecy_graph.nodes))
      .links(dependecy_graph.links)
      .linkStrength(default_link_strength)
      .start();

svg.append("defs").selectAll("marker")
    .data(["suit"])
  .enter().append("marker")
    .attr("id", function(d) { return d; })
    .attr("viewBox", "0 -5 10 10")
    .attr("refX", 10)
    .attr("refY", 0)
    .attr("markerWidth", 10)
    .attr("markerHeight", 10)
    .attr("orient", "auto")
  .append("path")
    .attr("d", "M0,-5L10,0L0,5");

var link = svg.append("g").selectAll("path")
    .data(dependecy_graph.links).
    enter().append("path")
    .attr("class", "link")
    .attr("marker-end", "url(#suit)")
    .style("stroke-width", function(d) { return Math.sqrt(1); })


var node = svg.append("g").selectAll(".node")
    .data(dependecy_graph.nodes)
    .enter().append("circle")
    .attr("r", radius)
    .style("fill", function(d) { return color(d.group) })
    .attr("class", "node")
    .attr("source", function(d) { return d.source})
    .attr("dest", function(d) { return d.dest})
    .call(force.drag)
    .on("mouseover", function(d) { 
        // I would like to insert an if statement to do all of these things to the connected nodes
        // if(isConnected(d, o)) {
          // d3.selectAll(".node").style("stroke-width", 6); 
                
                    // Figure out the neighboring node id's with brute strength because the graph is small
                    var nodeNeighbors = dependecy_graph.links.filter(function(link) {
                        // Filter the list of links to only those links that have our target 
                        // node as a source or target
                        return link.source.index === d.index || link.target.index === d.index;})
                    .map(function(link) {
                        // Map the list of links to a simple array of the neighboring indices - this is
                        // technically not required but makes the code below simpler because we can use         
                        // indexOf instead of iterating and searching ourselves.
                        return link.source.index === d.index ? link.target.index : link.source.index; });
                
                    // Reset all circles - we will do this in mouseout also
                    svg.selectAll('circle').style('fill-opacity', 0.1);
                    svg.selectAll('circle').style('stroke-opacity', 0.1);
                    svg.selectAll('path').style('stroke-opacity', 0.1);
                    svg.selectAll('path').style('fill-opacity', 0.1);
                    
                    // now we select the neighboring circles and apply whatever style we want. 
                    // Note that we could also filter a selection of links in this way if we want to 
                    // Highlight those as well
                    svg.selectAll('circle').filter(function(node) {
                        // I filter the selection of all circles to only those that hold a node with an
                        // index in my listg of neighbors
                        return nodeNeighbors.indexOf(node.index) > -1;
                    })
                    .style('fill-opacity', 1);
               
          // d3.select(this).select("circle").style("stroke", "orange"); 
          // d3.select(this).select("text").style("font", "20px sans-serif");
          // d3.selectAll("rect." + d.location).style("stroke-width", 6);
          // d3.selectAll("rect." + d.location).style("stroke", "orange");
          // d3.selectAll("text." + d.location).style("font", "20px sans-serif");
          // d3.selectAll("tr." + d.name).style("background-color", "orange");
          //}
        })
      .on("mouseout",  function(d) { 
        // if(isConnected(d, o)) {
          // svg.selectAll('circle').style('stroke', 'gray');
          svg.selectAll('circle').style('fill-opacity', 1);
          svg.selectAll('circle').style('stroke-opacity', 1);
          svg.selectAll('path').style('stroke-opacity', 1);
          svg.selectAll('path').style('fill-opacity', 1);

                    
          //d3.select(this).select("circle").style("stroke", "gray"); 
          // d3.select(this).select("text").style("font", "12px sans-serif");
          // d3.selectAll("rect." + d.location).style("stroke-width", 1.5);
          // d3.selectAll("rect." + d.location).style("stroke", "gray");
          // d3.selectAll("text." + d.location).style("font", "12px sans-serif");
          // d3.selectAll("tr." + d.name).style("background-color", "white");
          // //}
        });

 //  // Uncomment to have names near the classes

  var text = null;
   text = svg.append("g").selectAll("text")
    .data(force.nodes())
     .enter().append("text")
    .style("text-anchor", "middle")
    .text(function(d) { return d.name.substring(0,default_max_texts_length) });
 
  force.on("tick", function() {
    svg.selectAll(".node").attr("r", radius);
    link.attr("d", linkArc);
    node.attr("transform", transform );
    if (show_texts_near_circles) {
     text.attr("transform", transform);
    }
  });

  function linkArc(d) {
    var dx = d.target.x - d.source.x,
      dy = d.target.y - d.source.y,
      dr = Math.sqrt(dx * dx + dy * dy);

    var rsource = radius(d.sourceNode)/dr;
    var rdest = radius(d.targetNode)/dr;
    var startX = d.source.x + dx * rsource;      
    var startY = d.source.y + dy * rsource;      

    var endX = d.target.x - dx * rdest;      
    var endY = d.target.y - dy * rdest;      

    return "M" + startX+ "," + startY + "L" + endX+ "," + endY;
  }

  function transform(d) {
    return "translate(" + d.x + "," + d.y + ")";
  }

  function radius(d) {
    return deafult_circle_radius + deafult_circle_radius * d.source / 10;
  }

  d3.selectAll("input").on("change", function change() {
  if (this.name == "circle_size") {
    deafult_circle_radius = parseInt(this.value);
    force.linkDistance(function(l) { return radius(l.source) + radius(l.target) + default_link_distance;})
    force.start();
  }

  if (this.name == "charge_multiplier") {
    charge_multiplier = parseInt(this.value);
    // // deafult_circle_radius = parseInt(this.value);
    // // force.linkDistance(function(l) { return radius(l.source) + radius(l.target) + default_link_distance;})
    // force.charge(function(d) { return -d.weight * charge_multiplier;})
    force.start();
  }
  if (this.name == "link_strength") {
    default_link_strength = parseInt(this.value) / 10;
    force.linkStrength(default_link_strength);
    force.start();
  }

  if (this.name == "show_texts_near_circles") {
    console.log("Text value changed to '" + this.checked +'"');
    text.attr("visibility", this.checked ? "visible" : "hidden")
    show_texts_near_circles = this.checked
  }

});

   function updateWindow(){
     x = w.innerWidth || e.clientWidth || g.clientWidth;
     y = w.innerHeight|| e.clientHeight|| g.clientHeight;

     svg.attr("width", x).attr("height", y);
     force.size([x, y]).start();
  }
  window.onresize = updateWindow;

</script>